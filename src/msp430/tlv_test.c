// Tests whether the calculation of checksums is correct.

#include "tlv.c"

#include <unity.h>

#include <stdint.h>

void setUp(void) {}

void tearDown(void) {}

void erased_seg_a_checksum_invalid(void) {
  static const uint16_t seg_a[32] = {
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU};
  TEST_ASSERT_NOT_EQUAL(tlv_checksum(seg_a), seg_a[0]);
}

void valid_seg_a_checksum_calculated_correctly(void) {
  // clang-format off
  uint16_t seg_a[32] = {
#if 0
      // factory data from a MSP430G2211 device
      0xb2bcU, 0x26feU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0x10feU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0x0201U, 0x86baU
#else
      // factory data from a MSP403G2231 device
      0xb228U, 0x26feU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0x1010U, 0xffffU, 0xffffU,
      0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0xffffU, 0x0201U, 0x86c8U
#endif
  };
  // clang-format on
  TEST_ASSERT_EQUAL(tlv_checksum(seg_a), seg_a[0]);

  // invalidate seg_a data
  seg_a[3] = 0x1234U;
  TEST_ASSERT_NOT_EQUAL(tlv_checksum(seg_a), seg_a[0]);
}

int main(void) {
  UNITY_BEGIN();
  RUN_TEST(erased_seg_a_checksum_invalid);
  RUN_TEST(valid_seg_a_checksum_calculated_correctly);
  return UNITY_END();
}
